import numpy as np
from scipy.signal import butter, lfilter, lfilter_zi

class EOGFilter:
    def __init__(self, sampling_rate=512):
        self.sampling_rate = sampling_rate
        
        # Design low-pass Butterworth filter
        # Cutoff at 10 Hz
        nyquist_freq = sampling_rate / 2
        normalized_cutoff = 10.0 / nyquist_freq
        
        self.b, self.a = butter(
            N=4,                          # 4th order
            Wn=normalized_cutoff,         # Normalized frequency
            btype='low'                   # Low-pass
        )
        
        # Initialize filter state for streaming
        self.zi = lfilter_zi(self.b, self.a)
    
    def filter_sample(self, sample):
        """
        Filter a single sample (for real-time streaming)
        
        Args:
            sample: single value
        
        Returns:
            filtered_sample: single filtered value
        """
        filtered, self.zi = lfilter(self.b, self.a, [sample], zi=self.zi)
        return filtered
    
    def filter_buffer(self, signal):
        """
        Filter entire buffer
        
        Args:
            signal: numpy array
        
        Returns:
            filtered_signal: numpy array
        """
        filtered, _ = lfilter(self.b, self.a, signal, zi=self.zi)
        return filtered
    
    def reset_filter_state(self):
        """Reset filter state for new session"""
        self.zi = lfilter_zi(self.b, self.a)


# Usage
eog_filter = EOGFilter(sampling_rate=512)

# Real-time streaming
new_sample = 245.3
filtered_sample = eog_filter.filter_sample(new_sample)

# Or batch processing
filtered_eog = eog_filter.filter_buffer(raw_eog_data)
