<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSignals Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        .status-dot.disconnected {
            background: #ef4444;
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        canvas {
            max-height: 300px;
        }

        .data-table {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üß† BioSignals Live Dashboard</h1>
            <p>Real-time EMG, EOG, and EEG visualization</p>
        </header>

        <div class="status">
            <div class="status-item">
                <span class="status-dot disconnected" id="ws-status"></span>
                WebSocket: <span id="ws-text">Connecting...</span>
            </div>
            <div class="status-item">
                üìä Samples: <span id="sample-count">0</span>
            </div>
            <div class="status-item">
                ‚è±Ô∏è Last Update: <span id="last-update">--:--:--</span>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <div class="chart-title">üìç EMG (High-Pass 70Hz)</div>
                <canvas id="emg-chart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üëÅÔ∏è EOG (Low-Pass 10Hz)</div>
                <canvas id="eog-chart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üß† EEG (Notch 50Hz + Bandpass)</div>
                <canvas id="eeg-chart"></canvas>
            </div>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Stream</th>
                        <th>Latest Value (¬µV)</th>
                        <th>Timestamp</th>
                        <th>Samples/sec</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <tr>
                        <td>EMG</td>
                        <td id="emg-val">--</td>
                        <td id="emg-ts">--</td>
                        <td id="emg-rate">--</td>
                    </tr>
                    <tr>
                        <td>EOG</td>
                        <td id="eog-val">--</td>
                        <td id="eog-ts">--</td>
                        <td id="eog-rate">--</td>
                    </tr>
                    <tr>
                        <td>EEG</td>
                        <td id="eeg-val">--</td>
                        <td id="eeg-ts">--</td>
                        <td id="eeg-rate">--</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const WINDOW_SIZE = 512; // 1 second @ 512 Hz

        // Data buffers
        const buffers = {
            "BioSignals-EMG-Filtered": { data: [], rates: 0, lastVal: 0, lastTs: 0 },
            "BioSignals-EOG-Filtered": { data: [], rates: 0, lastVal: 0, lastTs: 0 },
            "BioSignals-EEG-Filtered": { data: [], rates: 0, lastVal: 0, lastTs: 0 }
        };

        let sampleCount = 0;
        let lastRateCalc = Date.now();
        let rates = { EMG: 0, EOG: 0, EEG: 0 };

        // Charts
        const charts = {};
        const colors = {
            EMG: 'rgb(255, 99, 132)',
            EOG: 'rgb(54, 162, 235)',
            EEG: 'rgb(75, 192, 75)'
        };

        function initCharts() {
            const chartConfigs = [
                { id: 'emg-chart', label: 'EMG', stream: 'BioSignals-EMG-Filtered', color: colors.EMG },
                { id: 'eog-chart', label: 'EOG', stream: 'BioSignals-EOG-Filtered', color: colors.EOG },
                { id: 'eeg-chart', label: 'EEG', stream: 'BioSignals-EEG-Filtered', color: colors.EEG }
            ];

            chartConfigs.forEach(cfg => {
                const ctx = document.getElementById(cfg.id).getContext('2d');
                charts[cfg.stream] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: WINDOW_SIZE }, (_, i) => i),
                        datasets: [{
                            label: cfg.label,
                            data: Array(WINDOW_SIZE).fill(0),
                            borderColor: cfg.color,
                            backgroundColor: cfg.color + '22',
                            tension: 0.1,
                            fill: true,
                            pointRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        animation: { duration: 0 },
                        scales: {
                            y: {
                                beginAtZero: true,
                                min: -3000,
                                max: 3000
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            });
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//localhost:8765`);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                document.getElementById('ws-status').className = 'status-dot connected';
                document.getElementById('ws-text').textContent = 'Connected';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                const stream = message.stream;
                const data = message.data;
                const ts = message.timestamp;

                if (stream in buffers) {
                    // Handle multi-channel data
                    const value = Array.isArray(data) ? data : data;
                    buffers[stream].data.push(value);
                    buffers[stream].lastVal = value;
                    buffers[stream].lastTs = ts;

                    // Keep only WINDOW_SIZE points
                    if (buffers[stream].data.length > WINDOW_SIZE) {
                        buffers[stream].data.shift();
                    }

                    // Update chart
                    if (charts[stream]) {
                        charts[stream].data.datasets.data = buffers[stream].data;
                        charts[stream].update('none'); // No animation
                    }

                    sampleCount++;
                    updateDisplay(stream);
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                document.getElementById('ws-status').className = 'status-dot disconnected';
                document.getElementById('ws-text').textContent = 'Disconnected';
            };

            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                document.getElementById('ws-status').className = 'status-dot disconnected';
                document.getElementById('ws-text').textContent = 'Reconnecting...';
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateDisplay(stream) {
            const mapping = {
                'BioSignals-EMG-Filtered': { val: 'emg-val', ts: 'emg-ts', rate: 'emg-rate' },
                'BioSignals-EOG-Filtered': { val: 'eog-val', ts: 'eog-ts', rate: 'eog-rate' },
                'BioSignals-EEG-Filtered': { val: 'eeg-val', ts: 'eeg-ts', rate: 'eeg-rate' }
            };

            const ids = mapping[stream];
            const buffer = buffers[stream];

            document.getElementById(ids.val).textContent = buffer.lastVal.toFixed(2);
            document.getElementById(ids.ts).textContent = new Date(buffer.lastTs * 1000).toLocaleTimeString();

            // Calculate sampling rate
            const now = Date.now();
            if (now - lastRateCalc > 1000) {
                const rate = (sampleCount / ((now - lastRateCalc) / 1000)).toFixed(1);
                document.querySelectorAll('[id$="-rate"]').forEach(el => {
                    el.textContent = rate;
                });
                sampleCount = 0;
                lastRateCalc = now;
            }

            // Update sample counter
            document.getElementById('sample-count').textContent = sampleCount;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            connectWebSocket();
        });
    </script>
</body>

</html>